version: 2
jobs:
  build:
    docker:
      - image: node:16.13.0
        auth:
          username: $DOCKERHUB_USR
          password: $DOCKERHUB_PWD
    steps:
      - checkout
      - run:
          name: Node Packages Download
          command: npm install
      - run:
          name: Project Build
          command: npm run build
      - run:
          name: Node CI Packages Download (No optionals)
          command: cd ./build && npm ci --production --no-optional
      - add_ssh_keys
      - run:
          name: Generate Artifact & Deploy
          command: |
            apt-get update && apt-get -y install rsync
            mkdir /tmp/artifacts
            tar -czf /tmp/build.tar.gz ./build
            ssh-keyscan -H $PRD_SERVER >> ~/.ssh/known_hosts
            rsync -va --delete /tmp/build.tar.gz $PRD_USR@$PRD_SERVER:$PRD_PATH
            ssh $PRD_USR@$PRD_SERVER <<'ENDSSH'
            cd $PRD_PATH
            rm -rf ./build
            tar -xf build.tar.gz
            pm2 stop 0
            pm2 start 0
            ENDSSH
      - store_artifacts:
          path: /tmp/build.tar.gz
          destination: artifact-file
